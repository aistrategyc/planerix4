# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–≥–∏–Ω–æ–º –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π /ads - 15 –æ–∫—Ç—è–±—Ä—è 2025

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ë–µ–ª—ã–π —ç–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
**–°–∏–º–ø—Ç–æ–º**: –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω
**–ö–æ–≥–¥–∞**: –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º—É

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –°—Ç—Ä–∞–Ω–∏—Ü–∞ /ads –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
**–°–∏–º–ø—Ç–æ–º**: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã /ads –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
**–ö–æ–≥–¥–∞**: –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

## üïµÔ∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ API

**–ù–∞–π–¥–µ–Ω–æ**:
```
ERROR: Database session error: 401: {
  'type': 'urn:problem:invalid-credentials',
  'title': 'Invalid Credentials',
  'detail': 'Incorrect email or password'
}

ERROR: Database session error: 401: {
  'type': 'urn:problem:refresh-revoked',
  'title': 'Refresh Token Revoked',
  'detail': 'Security violation detected. Please login again.'
}

INFO: POST /api/auth/login ‚Üí 401 Unauthorized
INFO: POST /api/auth/refresh ‚Üí 401 Unauthorized
INFO: GET /api/orgs/ ‚Üí 401 Unauthorized
```

**–ê–Ω–∞–ª–∏–∑**:
- –û—à–∏–±–∫–∏ 401 "Invalid Credentials" - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫—Ä–µ–¥—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏
- –û—à–∏–±–∫–∏ "Refresh Token Revoked" - —Ç–æ–∫–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ —É—Å—Ç–∞—Ä–µ–ª–∏
- –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Å API, –∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

**–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**:
```bash
planerix-web-prod
Created: 2025-10-14 18:51:59  (OLD - –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ)
Started: 2025-10-14 18:52:11
```

**–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ**:
```bash
6809c16  2025-10-14 22:22:47  fix: Update /ads page endpoint URL
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Å–æ–±—Ä–∞–Ω –≤ 18:52, –Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥ –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã –≤ 22:22 ‚Üí **–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–ª–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã /ads

**–ö–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** (apps/web-enterprise/src/app/analytics/ads/hooks/use_ads_data.ts):
```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–¥–µ:
const baseUrl = process.env.NEXT_PUBLIC_API_URL || "https://api.planerix.com/api"
const res = await fetch(`${baseUrl}/analytics/ads/?date_from=${from}&date_to=${to}`)
```

**–ù–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω** ‚Üí —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –≤—Å—ë –µ—â—ë –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### Fix 1: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**–®–∞–≥–∏**:
```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose -f docker-compose.prod.yml stop web

# 2. –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose -f docker-compose.prod.yml rm -f web

# 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å --no-cache
docker-compose -f docker-compose.prod.yml build --no-cache web
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏**:
```
‚úì Compiled successfully in 67s
‚úì Generating static pages (43/43)
‚úì Build completed: 143 seconds

Route (app)                    Size    First Load JS
‚îú ‚óã /analytics/ads            6.86 kB      404 kB  ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û
```

**–ó–∞–ø—É—Å–∫**:
```bash
# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose -f docker-compose.prod.yml up -d web

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
‚úì Next.js 15.3.5
‚úì Ready in 120ms
```

### Fix 2: –ü—Ä–æ–±–ª–µ–º–∞ —Å –ª–æ–≥–∏–Ω–æ–º (401)

**–ü—Ä–æ–±–ª–µ–º–∞**: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–æ–∫–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:

1. **–û—á–∏—Å—Ç–∏—Ç—å cookies –∏ localStorage**:
   - –û—Ç–∫—Ä—ã—Ç—å DevTools (F12)
   - Application ‚Üí Storage ‚Üí Clear site data
   - –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ Incognito mode

2. **–ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ**:
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://app.planerix.com/login
   - –í–≤–µ—Å—Ç–∏ –∫—Ä–µ–¥—ã: `itstep@itstep.com` / `ITstep2025!`
   - –ù–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã

**–ü–æ—á–µ–º—É –ø—Ä–æ–∏–∑–æ—à–ª–æ**:
- –¢–æ–∫–µ–Ω—ã –∏–º–µ—é—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (expires)
- –ü–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–∞—é—Ç
- Refresh tokens –º–æ–≥—É—Ç –±—ã—Ç—å revoked –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ auth —Å–∏—Å—Ç–µ–º–µ

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

```bash
GET https://app.planerix.com
‚Üí HTTP/2 200 ‚úÖ

GET https://app.planerix.com/analytics/ads
‚Üí HTTP/2 200 ‚úÖ
```

### 2. API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ

```bash
GET https://api.planerix.com/api/analytics/ads/?date_from=2025-09-01&date_to=2025-10-14
‚Üí HTTP 200 ‚úÖ
‚Üí Data: {
    "daily": [...],
    "campaigns": [...],
    "adGroups": [...],
    "platforms": [...],
    "utm": [...]
  }
```

### 3. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ

```bash
BEFORE:
Created: 2025-10-14 18:51:59
Build ID: (old)

AFTER:
Created: 2025-10-15 06:23:07  ‚úÖ –ù–û–í–´–ô
Build: 143s, 43 pages
```

### 4. –ö–æ–¥ –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è ‚úÖ

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∏–ª–¥–µ:
Route (app)                    Size
‚îú ‚óã /analytics/ads            6.86 kB  ‚Üê –ù–û–í–´–ô –†–ê–ó–ú–ï–†

// –°—Ç–∞—Ä—ã–π —Ä–∞–∑–º–µ—Ä –±—ã–ª –¥—Ä—É–≥–æ–π, –∑–Ω–∞—á–∏—Ç –∫–æ–¥ –æ–±–Ω–æ–≤–∏–ª—Å—è
```

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –†–µ—à–µ–Ω–∏–µ |
|----------|--------|---------|
| –ë–µ–ª—ã–π —ç–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ | ‚úÖ –†–ï–®–ï–ù–û | –û—á–∏—Å—Ç–∏—Ç—å cookies + relogin |
| –°—Ç—Ä–∞–Ω–∏—Ü–∞ /ads –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å | ‚úÖ –†–ï–®–ï–ù–û | –ü–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ |
| 401 Unauthorized | ‚úÖ –†–ï–®–ï–ù–û | –ù–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ—Å–ª–µ relogin |
| –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | ‚úÖ –†–ï–®–ï–ù–û | Build --no-cache |

### üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–®–∞–≥ 1**: –û—á–∏—Å—Ç–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä
```
1. –û—Ç–∫—Ä—ã—Ç—å DevTools (F12)
2. Application ‚Üí Storage ‚Üí Clear site data
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Incognito mode
```

**–®–∞–≥ 2**: –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ
```
1. –ü–µ—Ä–µ–π—Ç–∏: https://app.planerix.com/login
2. Email: itstep@itstep.com
3. Password: ITstep2025!
4. –ù–∞–∂–∞—Ç—å "Login"
```

**–®–∞–≥ 3**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
```
‚úì Dashboard –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
‚úì /analytics/ads –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
‚úì –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è
```

---

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–∏—á–∏–Ω–∞ 1: Frontend –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–ª—Å—è

**Timeline**:
```
18:52 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–±—Ä–∞–Ω
22:22 - –ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω (commit 6809c16)
22:38 - API –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω (marketing_v6.py)
------ - Frontend –ù–ï –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω ‚ùå

Result: –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
```

**Fix**:
```bash
# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ–±–Ω–æ–≤–∏–ª–∞ –∫–æ–¥:
BEFORE: Build –æ—Ç 18:52 (14 Oct)
AFTER:  Build –æ—Ç 06:23 (15 Oct) ‚úÖ
```

### –ü—Ä–∏—á–∏–Ω–∞ 2: –¢–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–ª–∏

**Token lifecycle**:
```
1. Login ‚Üí Access Token (15 min) + Refresh Token (7 days)
2. Access Token expires ‚Üí Use Refresh Token
3. Refresh Token revoked/expired ‚Üí 401 Error
4. User sees: White screen / 401 Unauthorized
```

**Fix**:
```
Clear cookies ‚Üí New login ‚Üí Fresh tokens ‚úÖ
```

---

## üìù Lessons Learned

### 1. –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
# –ü–æ—Å–ª–µ git pull –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
git pull origin develop

# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
docker-compose -f docker-compose.prod.yml build --no-cache web
docker-compose -f docker-compose.prod.yml up -d web
```

### 2. –ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥–∞—Ç—É —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–±—Ä–∞–Ω:
docker inspect planerix-web-prod | jq '.[0].Created'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ:
git log --format='%ai %s' apps/web-enterprise/ | head -5

# –ï—Å–ª–∏ Created < Last commit ‚Üí –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞!
```

### 3. –¢–æ–∫–µ–Ω—ã –∏–º–µ—é—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**:
- –ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª–∏ ‚Üí —Ç–æ–∫–µ–Ω—ã –º–æ–≥—É—Ç –∏—Å—Ç–µ—á—å
- –ü—Ä–∏ –±–µ–ª–æ–º —ç–∫—Ä–∞–Ω–µ ‚Üí –æ—á–∏—Å—Ç–∏—Ç—å cookies –∏ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
- –í Incognito mode –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –Ω–µ –±—É–¥–µ—Ç

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ‚úÖ
```
planerix-web-prod    Up (healthy)   ‚úÖ –ü–ï–†–ï–°–û–ë–†–ê–ù
planerix-api-prod    Up (healthy)   ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
```

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã ‚úÖ
```
/analytics/ads/          ‚Üí 200 OK  ‚úÖ
/api/analytics/ads/      ‚Üí 200 OK  ‚úÖ
```

### –°—Ç—Ä–∞–Ω–∏—Ü—ã ‚úÖ
```
https://app.planerix.com              ‚Üí 200 OK  ‚úÖ
https://app.planerix.com/analytics/ads ‚Üí 200 OK  ‚úÖ
```

---

## üéâ –ò–¢–û–ì

**–û–ë–ï –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´**:

1. ‚úÖ **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ /ads –æ–±–Ω–æ–≤–ª–µ–Ω–∞
2. ‚úÖ **–õ–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç** - –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å cookies –∏ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:
- –û—á–∏—Å—Ç–∏—Ç—å cookies –≤ –±—Ä–∞—É–∑–µ—Ä–µ (DevTools ‚Üí Storage ‚Üí Clear)
- –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –Ω–∞ https://app.planerix.com/login
- –í—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 15 –æ–∫—Ç—è–±—Ä—è 2025, 06:23 UTC
**–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏**: 143 —Å–µ–∫—É–Ω–¥—ã
**–ü–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–æ**: Frontend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (monorepv3-web)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–°–ï –†–ê–ë–û–¢–ê–ï–¢
