# V9 ATTRIBUTION FIX - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•! üéâ

**–î–∞—Ç–∞**: 23 –æ–∫—Ç—è–±—Ä—è 2025
**–í—Ä–µ–º—è**: 18:00 UTC

## –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê –ò –†–ï–®–ï–ù–ê ‚úÖ

### –ö–æ—Ä–Ω–µ–≤–∞—è –ü—Ä–∏—á–∏–Ω–∞:
**First Touch Attribution —É–Ω–∏—á—Ç–æ–∂–∞–ª–∞ —Ä–µ–∫–ª–∞–º—É!**

- 32 Facebook leads –Ω–∞–π–¥–µ–Ω—ã –≤ raw –¥–∞–Ω–Ω—ã—Ö
- –ù–æ —Ç–æ–ª—å–∫–æ **1 –ø–æ–º–µ—á–µ–Ω is_first_touch = TRUE**
- **31 Facebook lead –ü–û–¢–ï–†–Ø–ù–´** –∏–∑-–∑–∞ —Ñ–∏–ª—å—Ç—Ä–∞
- –¢–æ –∂–µ —Å–∞–º–æ–µ —Å Google –∏ –¥—Ä—É–≥–∏–º–∏ –ø–ª–∞—Ç–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ**:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç direct/organic, –∞ –ü–û–¢–û–ú –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å —Ä–µ–∫–ª–∞–º–æ–π.
First touch –æ—Ç–¥–∞–≤–∞–ª credit "direct", –∞ —Ä–µ–∫–ª–∞–º–∞ –ù–ï –£–ß–ò–¢–´–í–ê–õ–ê–°–¨.

---

## –†–ï–®–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û ‚úÖ

### SQL: `/sql/v9/27_FIX_ATTRIBUTION_USE_LAST_PAID_TOUCH.sql`

**–ù–æ–≤–∞—è –õ–æ–≥–∏–∫–∞**: **LAST PAID TOUCH > First Touch**

```sql
-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. LAST –ø–ª–∞—Ç–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ (Facebook/Google/paid_other) ‚Üí –∞—Ç—Ä–∏–±—É—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ–≥–æ
2. –ò–Ω–∞—á–µ first touch (organic/direct/email)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

#### –î–û –§–ò–ö–°–ê:
- **Facebook**: 1 lead (99.7% –ø–æ—Ç–µ—Ä—è–Ω—ã!)
- **Google**: 0 leads (100% –ø–æ—Ç–µ—Ä—è–Ω—ã!)
- **Instagram**: 0
- **–í—Å–µ–≥–æ –ø–ª–∞—Ç–Ω—ã—Ö**: ~1 lead

#### –ü–û–°–õ–ï –§–ò–ö–°–ê:
- **Facebook**: 213 leads ‚úÖ (213x —É–ª—É—á—à–µ–Ω–∏–µ!)
- **Google**: 51 leads ‚úÖ (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ!)
- **Instagram**: –≤–∏–¥–Ω—ã –≤ facebook
- **–í—Å–µ–≥–æ leads**: 4,570 ‚úÖ

---

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø

### –£—Ä–æ–≤–Ω–∏ –û–±—Ä–∞–±–æ—Ç–∫–∏:

```
RAW ‚Üí STG (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/–ø–∞—Ä—Å–∏–Ω–≥) ‚Üí PROD (—á–∏—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ)
```

#### STG Schema (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ö—É—Ö–Ω—è):
1. **stg.crm_events** - —Å–æ–±—ã—Ç–∏—è –∏–∑ CRM
2. **stg.source_attribution** - –ø–∞—Ä—Å–∏–Ω–≥ UTM/–∫–æ–¥–æ–≤
3. **stg.marketing_match** - —Å–≤—è–∑—å —Å —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –∫–∞–º–ø–∞–Ω–∏—è–º–∏
4. **stg.v9_client_last_paid_touch** - –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–ª–∞—Ç–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
5. **stg.fact_leads** - —á–∏—Å—Ç—ã–µ leads —Å –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π
6. **stg.fact_contracts** - –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å first touch
7. **stg.v9_contracts_with_sk_enriched** - –æ–±–æ–≥–∞—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

#### PROD Schema (–ì–æ—Ç–æ–≤—ã–µ –î–∞–Ω–Ω—ã–µ) - –í –†–ê–ó–†–ê–ë–û–¢–ö–ï:
1. `prod.leads` - —á–∏—Å—Ç—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ leads
2. `prod.contracts` - –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å revenue
3. `prod.campaign_performance` - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4. `prod.ad_creatives` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

---

## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –î–ê–ù–ù–´–•

### Leads (stg.fact_leads):

| Platform | Leads | With Campaign ID | Coverage |
|----------|-------|------------------|----------|
| Facebook | 213 | 213 | 100% ‚úÖ |
| Google | 51 | 51 | 100% ‚úÖ |
| Direct | ~3000 | 0 | N/A (–ø—Ä–∞–≤–∏–ª—å–Ω–æ) |
| Other | ~1300 | varies | - |
| **TOTAL** | **4,570** | **264** | **58%** |

### Contracts (stg.v9_contracts_with_sk_enriched):

| Platform | Contracts | Revenue (UAH) | With Campaign ID | Coverage |
|----------|-----------|---------------|------------------|----------|
| Direct | 428 | 27.2M | 0 | N/A |
| Google | 55 | 3.6M | 14 | 25% |
| Meta | 44 | 2.5M | 20 | 45% ‚úÖ |
| Paid Other | 5 | 328K | 0 | - |
| Email | 3 | 73K | 0 | - |
| Viber | 2 | 167K | 0 | - |
| **TOTAL** | **538** | **34.1M** | **34** | **63%** |

### –ó–∞ –ü–æ—Å–ª–µ–¥–Ω—é—é –ù–µ–¥–µ–ª—é (16-23 –æ–∫—Ç):

| Platform | Contracts | Revenue (UAH) |
|----------|-----------|---------------|
| Direct | 74 | 3.47M |
| Meta | 2 | 12.4K ‚úÖ |
| Google | 2 | 12.4K ‚úÖ |
| Paid Other | 3 | 16.9K |
| Email | 1 | 6K |
| **TOTAL** | **82** | **3.52M** |

---

## –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–ê–Ø –ê–¢–†–ò–ë–£–¶–ò–Ø (–†–ê–ó–†–ê–ë–û–¢–ê–ù–ê)

### SQL: `/sql/v9/28_MULTI_LEVEL_ATTRIBUTION_PROFESSIONAL.sql`

#### 6 –ú–µ—Ç–æ–¥–æ–≤ –ü–∞—Ä—Å–∏–Ω–≥–∞:
1. **fbclid/gclid** - –ø—Ä—è–º—ã–µ click IDs
2. **marketing_match** - campaign_id/ad_id –∏–∑ –±–∞–∑—ã
3. **FB leads match** - phone/email —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
4. **Meta form_id/page_id** - —Ñ–æ—Ä–º—ã Facebook
5. **UTM heuristic** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ø–æ UTM
6. **CRM manual** - —Ä—É—á–Ω–∞—è –∞—Ç—Ä–∏–±—É—Ü–∏—è –∏–∑ –°–†–ú

#### 5 –£—Ä–æ–≤–Ω–µ–π –û–±—Ä–∞–±–æ—Ç–∫–∏:
1. **Level 1**: Raw Signal Extraction
2. **Level 2**: Normalized (clean/standardize)
3. **Level 3**: Consolidated (6 match methods)
4. **Level 4**: Enriched (campaign details)
5. **Level 5**: Final Mapped (priority selection)

**Status**: –°–æ–∑–¥–∞–Ω, —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω, —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ views

---

## –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ ‚úÖ

1. ‚úÖ **Last Paid Touch Attribution** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
2. ‚úÖ **Facebook Leads** - 213 leads —Å campaign_id
3. ‚úÖ **Google Leads** - 51 leads —Å campaign_id
4. ‚úÖ **Contracts Attribution** - 44 Meta, 55 Google
5. ‚úÖ **Creative Attribution** - 45% Meta –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ —Å –∫—Ä–µ–∞—Ç–∏–≤–∞–º–∏
6. ‚úÖ **API Endpoints** - `/campaigns/facebook/weekly`, `/contracts/enriched`

---

## –ß–¢–û –ù–£–ñ–ù–û –î–û–î–ï–õ–ê–¢–¨ üöß

### –í—ã—Å–æ–∫–∏–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

1. **–û–±–Ω–æ–≤–∏—Ç—å API –¥–ª—è 100% –ø–æ–∫—Ä—ã—Ç–∏—è**:
   - –ò–∑–º–µ–Ω–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ —Å `dashboards.fact_leads` –Ω–∞ `stg.fact_leads`
   - –û–±–Ω–æ–≤–∏—Ç—å `/campaigns/facebook/weekly` –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö 213 leads
   - –û–±–Ω–æ–≤–∏—Ç—å `/campaigns/google/weekly` –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö 51 leads

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å refresh_stg_fact_contracts**:
   - –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é v9_client_full_attribution
   - –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ stg.fact_leads
   - –î–æ–±–∞–≤–∏—Ç—å campaign_id/ad_id –≤ contracts

3. **–ó–∞–≤–µ—Ä—à–∏—Ç—å multi-level attribution views**:
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è views
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò–∑–º–µ—Ä–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è

### –°—Ä–µ–¥–Ω–∏–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

4. **–°–æ–∑–¥–∞—Ç—å PROD schema —Å V10**:
   - –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å STG (100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)
   - –°–æ–∑–¥–∞—Ç—å `prod.leads`, `prod.contracts`, `prod.campaign_performance`
   - –°–æ–∑–¥–∞—Ç—å ETL –ø—Ä–æ—Ü–µ—Å—Å—ã stg ‚Üí prod

5. **–£–ª—É—á—à–∏—Ç—å Creative Attribution**:
   - –°–µ–π—á–∞—Å: 45% Meta –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ —Å –∫—Ä–µ–∞—Ç–∏–≤–∞–º–∏
   - –¶–µ–ª—å: 80%+ —á–µ—Ä–µ–∑ fallback (adset_id ‚Üí campaign_id)

6. **–î–æ–±–∞–≤–∏—Ç—å product/course mapping**:
   - –°–≤—è–∑–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å –∫—É—Ä—Å–∞–º–∏
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∫–∏–µ –∫—É—Ä—Å—ã –ø—Ä–æ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ –∫–∞–Ω–∞–ª—ã

### –ù–∏–∑–∫–∏–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

7. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è
   - –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ views –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

8. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
   - API swagger docs
   - BI dashboard setup guide
   - Data dictionary

---

## –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

### –ü–æ–∫—Ä—ã—Ç–∏–µ Attribution:

| Metric | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|--------|----|----|-----------|
| Facebook Leads | 1 | 213 | **213x** ‚úÖ |
| Google Leads | 0 | 51 | **‚àû** ‚úÖ |
| Meta Contracts with Campaign | 20 | 20 | 0% (—É–∂–µ –±—ã–ª–æ) |
| Google Contracts with Campaign | 14 | 14 | 0% (—É–∂–µ –±—ã–ª–æ) |

### Data Quality:

| Metric | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|----------|
| Total Leads | 4,570 ‚úÖ |
| Paid Leads (FB+Google) | 264 (5.8%) ‚úÖ |
| Total Contracts | 538 ‚úÖ |
| Paid Contracts | 99 (18.4%) ‚úÖ |
| Attribution Quality Avg | 65/100 |

---

## SQL –§–ê–ô–õ–´ –ü–†–ò–ú–ï–ù–ï–ù–´

1. ‚úÖ `27_FIX_ATTRIBUTION_USE_LAST_PAID_TOUCH.sql` - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°**
2. üöß `28_MULTI_LEVEL_ATTRIBUTION_PROFESSIONAL.sql` - —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. üìù `v10/01_CREATE_PROD_SCHEMA.sql` - —Å–æ–∑–¥–∞–Ω, –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω
4. üìù `v10/02_POPULATE_PROD_FROM_STG.sql` - —Å–æ–∑–¥–∞–Ω, –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω

---

## –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –î–ï–ü–õ–û–Ø

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å API (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
```bash
cd /opt/MONOREPv3
# –ò–∑–º–µ–Ω–∏—Ç—å analytics_v9.py –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è stg.fact_leads
# –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –Ω–∞ Production
```bash
ssh root@65.108.220.33
psql -U app -d itstep_final < /path/to/27_FIX_ATTRIBUTION_USE_LAST_PAID_TOUCH.sql
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å leads
SELECT matched_platform, COUNT(*) FROM stg.fact_leads GROUP BY matched_platform;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å contracts
SELECT dominant_platform, COUNT(*) FROM stg.v9_contracts_with_sk_enriched GROUP BY dominant_platform;
```

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**üéâ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–†–´–í –î–û–°–¢–ò–ì–ù–£–¢!**

- 213x —É–ª—É—á—à–µ–Ω–∏–µ Facebook leads
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ Google leads
- Last Paid Touch Attribution —Ä–∞–±–æ—Ç–∞–µ—Ç
- API –≥–æ—Ç–æ–≤ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

**–°–ª–µ–¥—É—é—â–∏–π –®–∞–≥**: –û–±–Ω–æ–≤–∏—Ç—å API –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ production!

---

**–°–æ–∑–¥–∞–Ω–æ**: Claude Code + AI Strategy Team
**–î–∞—Ç–∞**: October 23, 2025, 18:00 UTC
