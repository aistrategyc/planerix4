# –¢–µ–∫—É—â–∞—è –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö - –ê–Ω–∞–ª–∏–∑ –∏ –ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è Planerix Analytics

## –ê–Ω–∞–ª–∏–∑ –¢–µ–∫—É—â–µ–π –°—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¢–∞–±–ª–∏—Ü—ã –≤ staging

1. **crm_requests_attribution** - –ê—Ç—Ä–∏–±—É—Ü–∏—è CRM –∑–∞–ø—Ä–æ—Å–æ–≤
2. **crm_requests** - CRM –∑–∞–ø—Ä–æ—Å—ã (–ª–∏–¥—ã)
3. **fb_ads_creative_insights** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ Facebook
4. **fb_ads_adset_insights** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π Facebook
5. **fb_ads_campaign_insights** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π Facebook
6. **ga4_sessions** - –°–µ—Å—Å–∏–∏ Google Analytics 4
7. **ga4_events** - –°–æ–±—ã—Ç–∏—è Google Analytics 4

---

## –ú–∞–ø–ø–∏–Ω–≥ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–∞–±–ª–∏—Ü –Ω–∞ –¢—Ä–µ–±—É–µ–º—É—é –°—Ç—Ä—É–∫—Ç—É—Ä—É

### 1. CRM –∏ –õ–∏–¥—ã

#### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞: `crm_requests`
**–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `leads`:**

| –¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–ª–µ | –¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------------|--------------|-----|------------|
| id | request_id | bigint | ‚úÖ –ï—Å—Ç—å |
| external_id | request_id | bigint | ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
| first_name | request_name | text | ‚úÖ –ï—Å—Ç—å (–Ω—É–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å) |
| last_name | request_name | text | ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å |
| email | request_email | text | ‚úÖ –ï—Å—Ç—å |
| phone | request_phone | text | ‚úÖ –ï—Å—Ç—å |
| age | - | - | ‚ùå –ù–µ—Ç |
| gender | - | - | ‚ùå –ù–µ—Ç |
| city | request_city | text | ‚úÖ –ï—Å—Ç—å |
| source_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å |
| campaign_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å |
| creative_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å |
| product_id | request_product | text | ‚ö†Ô∏è –ù—É–∂–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è |
| branch_id | request_branch | text | ‚ö†Ô∏è –ù—É–∂–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è |
| lead_score | - | - | ‚ùå –ù–µ—Ç |
| temperature | - | - | ‚ùå –ù–µ—Ç |
| status | request_status | text | ‚úÖ –ï—Å—Ç—å |
| stage | - | - | ‚ùå –ù–µ—Ç |
| contract_value | - | - | ‚ùå –ù–µ—Ç |
| payment_status | - | - | ‚ùå –ù–µ—Ç |
| created_at | request_created_at | timestamp | ‚úÖ –ï—Å—Ç—å |
| last_contact_at | - | - | ‚ùå –ù–µ—Ç |

**SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è VIEW:**
\`\`\`sql
CREATE OR REPLACE VIEW v_leads AS
SELECT 
    r.request_id as id,
    r.request_id::text as external_id,
    SPLIT_PART(r.request_name, ' ', 1) as first_name,
    CASE 
        WHEN array_length(string_to_array(r.request_name, ' '), 1) > 1 
        THEN array_to_string(string_to_array(r.request_name, ' ')[2:], ' ')
        ELSE NULL 
    END as last_name,
    r.request_email as email,
    r.request_phone as phone,
    NULL::integer as age,
    NULL::varchar as gender,
    r.request_city as city,
    a.source_id,
    a.campaign_id,
    a.creative_id,
    p.id as product_id,
    b.id as branch_id,
    0 as lead_score,
    'cold' as temperature,
    r.request_status as status,
    'lead' as stage,
    NULL::decimal as contract_value,
    NULL::varchar as payment_status,
    r.request_created_at as created_at,
    r.request_created_at as last_contact_at
FROM staging.crm_requests r
LEFT JOIN staging.crm_requests_attribution a ON r.request_id = a.request_id
LEFT JOIN products p ON r.request_product = p.name
LEFT JOIN branches b ON r.request_branch = b.name;
\`\`\`

---

#### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞: `crm_requests_attribution`
**–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–≤—è–∑–∏ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏:**

| –¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–ª–µ | –¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------------|--------------|-----|------------|
| utm_source | utm_source | text | ‚úÖ –ï—Å—Ç—å |
| utm_medium | utm_medium | text | ‚úÖ –ï—Å—Ç—å |
| utm_campaign | utm_campaign | text | ‚úÖ –ï—Å—Ç—å |
| utm_content | utm_content | text | ‚úÖ –ï—Å—Ç—å |
| utm_term | utm_term | text | ‚úÖ –ï—Å—Ç—å |
| source_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å —Å traffic_sources |
| campaign_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å —Å campaigns |
| creative_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å —Å creatives |

---

### 2. Facebook Ads - –ö—Ä–µ–∞—Ç–∏–≤—ã

#### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞: `fb_ads_creative_insights`
**–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `creative_daily_stats`:**

| –¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–ª–µ | –¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------------|--------------|-----|------------|
| creative_id | ad_id | text | ‚úÖ –ï—Å—Ç—å |
| date | date_start | date | ‚úÖ –ï—Å—Ç—å |
| impressions | impressions | numeric | ‚úÖ –ï—Å—Ç—å |
| clicks | clicks | numeric | ‚úÖ –ï—Å—Ç—å |
| reach | reach | numeric | ‚úÖ –ï—Å—Ç—å |
| frequency | frequency | numeric | ‚úÖ –ï—Å—Ç—å |
| conversions | actions_offsite_conversion_fb_pixel_purchase | numeric | ‚úÖ –ï—Å—Ç—å |
| leads | actions_offsite_conversion_fb_pixel_lead | numeric | ‚úÖ –ï—Å—Ç—å |
| spend | spend | numeric | ‚úÖ –ï—Å—Ç—å |
| revenue | - | - | ‚ùå –ù–µ—Ç |
| ctr | ctr | numeric | ‚úÖ –ï—Å—Ç—å |
| cpc | cpc | numeric | ‚úÖ –ï—Å—Ç—å |
| cpa | cost_per_action_type_offsite_conversion | numeric | ‚úÖ –ï—Å—Ç—å |
| cpm | cpm | numeric | ‚úÖ –ï—Å—Ç—å |
| roas | - | - | ‚ùå –ù—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å |
| cvr | - | - | ‚ö†Ô∏è –ú–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å |
| engagement_count | - | - | ‚ö†Ô∏è –ú–æ–∂–Ω–æ —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å actions |
| video_views | video_play_actions | numeric | ‚úÖ –ï—Å—Ç—å |
| video_view_rate | video_thruplay_watched_actions | numeric | ‚úÖ –ï—Å—Ç—å |

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ fb_ads_creative_insights:**
- impressions, clicks, reach, frequency
- ctr, cpc, cpm
- spend
- actions (multiple types)
- video metrics
- engagement metrics
- conversion metrics

**SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è VIEW:**
\`\`\`sql
CREATE OR REPLACE VIEW v_creative_daily_stats AS
SELECT 
    c.ad_id::text as creative_id,
    c.date_start as date,
    c.impressions::integer,
    c.clicks::integer,
    c.reach::integer,
    c.frequency::decimal,
    COALESCE(c.actions_offsite_conversion_fb_pixel_purchase, 0)::integer as conversions,
    COALESCE(c.actions_offsite_conversion_fb_pixel_lead, 0)::integer as leads,
    c.spend::decimal,
    NULL::decimal as revenue, -- –ù—É–∂–Ω–æ –¥–∂–æ–π–Ω–∏—Ç—å —Å CRM
    c.ctr::decimal,
    c.cpc::decimal,
    c.cost_per_action_type_offsite_conversion::decimal as cpa,
    c.cpm::decimal,
    NULL::decimal as roas, -- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ revenue
    CASE 
        WHEN c.clicks > 0 THEN (COALESCE(c.actions_offsite_conversion_fb_pixel_purchase, 0)::decimal / c.clicks * 100)
        ELSE 0 
    END as cvr,
    COALESCE(c.actions_like + c.actions_comment + c.actions_post_reaction, 0)::integer as engagement_count,
    c.video_play_actions::integer as video_views,
    c.video_thruplay_watched_actions::decimal as video_view_rate
FROM staging.fb_ads_creative_insights c;
\`\`\`

---

### 3. Facebook Ads - –ö–∞–º–ø–∞–Ω–∏–∏

#### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞: `fb_ads_campaign_insights`
**–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `campaign_daily_stats`:**

| –¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–ª–µ | –¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------------|--------------|-----|------------|
| campaign_id | campaign_id | text | ‚úÖ –ï—Å—Ç—å |
| date | date_start | date | ‚úÖ –ï—Å—Ç—å |
| impressions | impressions | numeric | ‚úÖ –ï—Å—Ç—å |
| clicks | clicks | numeric | ‚úÖ –ï—Å—Ç—å |
| reach | reach | numeric | ‚úÖ –ï—Å—Ç—å |
| spend | spend | numeric | ‚úÖ –ï—Å—Ç—å |
| conversions | actions_offsite_conversion | numeric | ‚úÖ –ï—Å—Ç—å |
| ctr | ctr | numeric | ‚úÖ –ï—Å—Ç—å |
| cpc | cpc | numeric | ‚úÖ –ï—Å—Ç—å |
| cpa | cost_per_action_type | numeric | ‚úÖ –ï—Å—Ç—å |
| roas | - | - | ‚ùå –ù–µ—Ç |

---

### 4. Google Analytics 4 - –°–µ—Å—Å–∏–∏

#### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞: `ga4_sessions`
**–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `traffic_sessions`:**

| –¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–ª–µ | –¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------------|--------------|-----|------------|
| session_id | session_id | text | ‚úÖ –ï—Å—Ç—å |
| user_id | user_pseudo_id | text | ‚úÖ –ï—Å—Ç—å |
| source_id | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–≤—è–∑—å |
| utm_source | session_source | text | ‚úÖ –ï—Å—Ç—å |
| utm_medium | session_medium | text | ‚úÖ –ï—Å—Ç—å |
| utm_campaign | session_campaign | text | ‚úÖ –ï—Å—Ç—å |
| device_type | device_category | text | ‚úÖ –ï—Å—Ç—å |
| browser | device_web_browser | text | ‚úÖ –ï—Å—Ç—å |
| os | device_operating_system | text | ‚úÖ –ï—Å—Ç—å |
| country | geo_country | text | ‚úÖ –ï—Å—Ç—å |
| city | geo_city | text | ‚úÖ –ï—Å—Ç—å |
| page_views | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑ events |
| duration | session_engaged_time | integer | ‚úÖ –ï—Å—Ç—å |
| bounce | - | - | ‚ö†Ô∏è –ú–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å |
| converted | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–∂–æ–π–Ω–∏—Ç—å —Å conversions |
| started_at | session_start_timestamp | timestamp | ‚úÖ –ï—Å—Ç—å |
| ended_at | - | - | ‚ö†Ô∏è –ú–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å |

**SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è VIEW:**
\`\`\`sql
CREATE OR REPLACE VIEW v_traffic_sessions AS
SELECT 
    s.session_id,
    s.user_pseudo_id as user_id,
    NULL::integer as source_id, -- –ù—É–∂–Ω–∞ —Å–≤—è–∑—å
    NULL::integer as campaign_id,
    s.session_source as utm_source,
    s.session_medium as utm_medium,
    s.session_campaign as utm_campaign,
    s.device_category as device_type,
    s.device_web_browser as browser,
    s.device_operating_system as os,
    s.geo_country as country,
    s.geo_city as city,
    0 as page_views, -- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑ events
    s.session_engaged_time as duration,
    CASE WHEN s.session_engaged_time < 10 THEN true ELSE false END as bounce,
    false as converted, -- –î–∂–æ–π–Ω —Å conversions
    s.session_start_timestamp as started_at,
    NULL::timestamp as ended_at
FROM staging.ga4_sessions s;
\`\`\`

---

### 5. Google Analytics 4 - –°–æ–±—ã—Ç–∏—è

#### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞: `ga4_events`
**–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `funnel_events`:**

| –¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–ª–µ | –¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------------|--------------|-----|------------|
| user_id | user_pseudo_id | text | ‚úÖ –ï—Å—Ç—å |
| session_id | session_id | text | ‚úÖ –ï—Å—Ç—å |
| event_type | event_name | text | ‚úÖ –ï—Å—Ç—å |
| event_stage | - | - | ‚ö†Ô∏è –ù—É–∂–Ω–æ –º–∞–ø–ø–∏—Ç—å |
| utm_source | utm_source | text | ‚úÖ –ï—Å—Ç—å |
| utm_medium | utm_medium | text | ‚úÖ –ï—Å—Ç—å |
| utm_campaign | utm_campaign | text | ‚úÖ –ï—Å—Ç—å |
| device_type | device_category | text | ‚úÖ –ï—Å—Ç—å |
| country | geo_country | text | ‚úÖ –ï—Å—Ç—å |
| city | geo_city | text | ‚úÖ –ï—Å—Ç—å |
| page_url | page_location | text | ‚úÖ –ï—Å—Ç—å |
| referrer_url | page_referrer | text | ‚úÖ –ï—Å—Ç—å |
| event_timestamp | event_timestamp | timestamp | ‚úÖ –ï—Å—Ç—å |

**–ú–∞–ø–ø–∏–Ω–≥ event_name –Ω–∞ event_type:**
\`\`\`sql
CASE event_name
    WHEN 'page_view' THEN 'page_view'
    WHEN 'form_submit' THEN 'lead'
    WHEN 'generate_lead' THEN 'lead'
    WHEN 'purchase' THEN 'purchase'
    WHEN 'add_to_cart' THEN 'add_to_cart'
    WHEN 'begin_checkout' THEN 'begin_checkout'
    ELSE event_name
END
\`\`\`

---

## –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –î–∞–Ω–Ω—ã–µ

### 1. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (Critical - –±–µ–∑ –Ω–∏—Ö –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)

#### ‚ùå `products` - –ü—Ä–æ–¥—É–∫—Ç—ã
\`\`\`sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    category VARCHAR(100),
    price DECIMAL(10, 2),
    duration_months INTEGER,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π request_product
INSERT INTO products (name, category, price)
SELECT DISTINCT 
    request_product,
    'IT Education',
    CASE 
        WHEN request_product LIKE '%–¥—ñ—Ç–µ–π%' THEN 2800
        WHEN request_product LIKE '%Front-end%' THEN 4800
        WHEN request_product LIKE '%QA%' THEN 4200
        ELSE 3500
    END
FROM staging.crm_requests
WHERE request_product IS NOT NULL;
\`\`\`

#### ‚ùå `branches` - –§–∏–ª–∏–∞–ª—ã
\`\`\`sql
CREATE TABLE branches (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    city VARCHAR(100) NOT NULL,
    region VARCHAR(100),
    is_active BOOLEAN DEFAULT true
);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π request_branch
INSERT INTO branches (name, city, region)
SELECT DISTINCT 
    request_branch,
    request_city,
    CASE 
        WHEN request_city = '–ö–∏—ó–≤' THEN '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city = '–•–∞—Ä–∫—ñ–≤' THEN '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city = '–î–Ω—ñ–ø—Ä–æ' THEN '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city = '–õ—å–≤—ñ–≤' THEN '–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city = '–û–¥–µ—Å–∞' THEN '–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        ELSE NULL
    END
FROM staging.crm_requests
WHERE request_branch IS NOT NULL;
\`\`\`

#### ‚ùå `traffic_sources` - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
\`\`\`sql
CREATE TABLE traffic_sources (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    type VARCHAR(50),
    platform VARCHAR(50),
    is_active BOOLEAN DEFAULT true
);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ GA4 –∏ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
INSERT INTO traffic_sources (name, type, platform)
SELECT DISTINCT 
    session_source,
    CASE 
        WHEN session_medium = 'cpc' THEN 'paid'
        WHEN session_medium = 'organic' THEN 'organic'
        WHEN session_medium = '(none)' THEN 'direct'
        ELSE 'referral'
    END,
    CASE 
        WHEN session_source ILIKE '%facebook%' THEN 'Facebook'
        WHEN session_source ILIKE '%google%' THEN 'Google'
        WHEN session_source ILIKE '%instagram%' THEN 'Instagram'
        ELSE session_source
    END
FROM staging.ga4_sessions
WHERE session_source IS NOT NULL;
\`\`\`

---

### 2. –°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ (Critical)

#### ‚ùå `campaigns` - –¢–∞–±–ª–∏—Ü–∞ –∫–∞–º–ø–∞–Ω–∏–π
\`\`\`sql
CREATE TABLE campaigns (
    id SERIAL PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE, -- campaign_id –∏–∑ Facebook
    name VARCHAR(255) NOT NULL,
    product_id INTEGER REFERENCES products(id),
    branch_id INTEGER REFERENCES branches(id),
    source_id INTEGER REFERENCES traffic_sources(id),
    objective VARCHAR(50),
    status VARCHAR(50) DEFAULT 'active',
    budget DECIMAL(10, 2),
    start_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ Facebook –∫–∞–º–ø–∞–Ω–∏–π
INSERT INTO campaigns (external_id, name, source_id, status)
SELECT DISTINCT 
    campaign_id,
    campaign_name,
    (SELECT id FROM traffic_sources WHERE name = 'Facebook' LIMIT 1),
    'active'
FROM staging.fb_ads_campaign_insights
WHERE campaign_id IS NOT NULL;
\`\`\`

#### ‚ùå `creatives` - –¢–∞–±–ª–∏—Ü–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
\`\`\`sql
CREATE TABLE creatives (
    id SERIAL PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE, -- ad_id –∏–∑ Facebook
    campaign_id INTEGER REFERENCES campaigns(id),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50),
    platform VARCHAR(50),
    product_id INTEGER REFERENCES products(id),
    branch_id INTEGER REFERENCES branches(id),
    title TEXT,
    body TEXT,
    status VARCHAR(50) DEFAULT 'active',
    is_personalized BOOLEAN DEFAULT false,
    theme VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ Facebook –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
INSERT INTO creatives (external_id, name, type, platform, status)
SELECT DISTINCT 
    ad_id,
    ad_name,
    'image', -- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –ª–æ–≥–∏–∫–æ–π
    'Facebook',
    'active'
FROM staging.fb_ads_creative_insights
WHERE ad_id IS NOT NULL;
\`\`\`

---

### 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ CRM (Medium Priority)

–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
- `age` - –≤–æ–∑—Ä–∞—Å—Ç –ª–∏–¥–∞
- `gender` - –ø–æ–ª –ª–∏–¥–∞
- `lead_score` - –æ—Ü–µ–Ω–∫–∞ –ª–∏–¥–∞ (0-100)
- `temperature` - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ª–∏–¥–∞ (hot/warm/cold)
- `stage` - —ç—Ç–∞–ø –≤ –≤–æ—Ä–æ–Ω–∫–µ
- `contract_value` - —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
- `payment_status` - —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
- `last_contact_at` - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞

---

### 4. Revenue –¥–∞–Ω–Ω—ã–µ (Critical –¥–ª—è ROAS)

#### ‚ùå –°–≤—è–∑—å –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ —Å –¥–æ—Ö–æ–¥–æ–º
–ù—É–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å:
- `fb_ads_creative_insights.ad_id` ‚Üí `crm_requests_attribution.creative_id` ‚Üí `crm_requests.contract_value`

**–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - VIEW –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ revenue:**
\`\`\`sql
CREATE OR REPLACE VIEW v_creative_revenue AS
SELECT 
    a.creative_id,
    c.date_start as date,
    COUNT(DISTINCT r.request_id) as conversions,
    SUM(CASE WHEN r.request_status = 'converted' THEN 
        COALESCE(r.contract_value, 
            CASE 
                WHEN r.request_product LIKE '%Front-end%' THEN 4800
                WHEN r.request_product LIKE '%QA%' THEN 4200
                WHEN r.request_product LIKE '%–¥—ñ—Ç–µ–π%' THEN 2800
                ELSE 3500
            END
        )
        ELSE 0 
    END) as revenue
FROM staging.crm_requests_attribution a
JOIN staging.crm_requests r ON a.request_id = r.request_id
JOIN staging.fb_ads_creative_insights c ON a.creative_id = c.ad_id
WHERE a.creative_id IS NOT NULL
GROUP BY a.creative_id, c.date_start;
\`\`\`

---

### 5. –¢–∞–±–ª–∏—Ü–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π (Medium Priority)

#### ‚ùå `lead_interactions` - –ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –ª–∏–¥–∞–º–∏
\`\`\`sql
CREATE TABLE lead_interactions (
    id SERIAL PRIMARY KEY,
    lead_id INTEGER REFERENCES crm_requests(request_id),
    type VARCHAR(50), -- 'phone_call', 'email', 'consultation', etc.
    details TEXT,
    outcome VARCHAR(50),
    duration INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
\`\`\`

---

### 6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (Low Priority)

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç:
- `hook_rate` - –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
- `thumb_stops` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
- `saves` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–ª—è Instagram)
- `shares` - —Ä–µ–ø–æ—Å—Ç—ã
- `comments` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- `engagement_rate` - –æ–±—â–∏–π engagement

---

### 7. –î–∞–Ω–Ω—ã–µ –æ —Ç–µ–º–∞—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (Medium Priority)

#### ‚ùå –ü–æ–ª–µ `theme` –≤ –∫—Ä–µ–∞—Ç–∏–≤–∞—Ö
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é:
- "–ö–∞—Ä'—î—Ä–∞"
- "–ì—Ä–æ—à—ñ"
- "–ó–º—ñ–Ω–∏"
- "–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏"
- "–ì–∞—Ä–∞–Ω—Ç—ñ—ó"
- "–ù–∞–≤—á–∞–Ω–Ω—è –∑ –Ω—É–ª—è"
- "–ï–º–æ—Ü—ñ–π–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞"

**–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ ALTER:**
\`\`\`sql
ALTER TABLE creatives ADD COLUMN theme VARCHAR(100);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–∑–≤–∞–Ω–∏–π/—Ç–µ–∫—Å—Ç–æ–≤
UPDATE creatives 
SET theme = CASE 
    WHEN name ILIKE '%career%' OR name ILIKE '%–∫–∞—Ä''—î—Ä%' THEN '–ö–∞—Ä''—î—Ä–∞'
    WHEN name ILIKE '%money%' OR name ILIKE '%–≥—Ä–æ—à%' OR name ILIKE '%salary%' THEN '–ì—Ä–æ—à—ñ'
    WHEN name ILIKE '%change%' OR name ILIKE '%–∑–º—ñ–Ω%' THEN '–ó–º—ñ–Ω–∏'
    WHEN name ILIKE '%certificate%' OR name ILIKE '%—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç%' THEN '–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏'
    WHEN name ILIKE '%guarantee%' OR name ILIKE '%–≥–∞—Ä–∞–Ω—Ç%' THEN '–ì–∞—Ä–∞–Ω—Ç—ñ—ó'
    WHEN name ILIKE '%zero%' OR name ILIKE '%–Ω—É–ª—è%' THEN '–ù–∞–≤—á–∞–Ω–Ω—è –∑ –Ω—É–ª—è'
    ELSE NULL
END;
\`\`\`

---

## –ú–∞–ø–ø–∏–Ω–≥ –ø–æ –°—Ç—Ä–∞–Ω–∏—Ü–∞–º –∏ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º

### –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: MetricCard
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
-- Revenue
SELECT SUM(spend) as total_spend, COUNT(DISTINCT campaign_id) as projects
FROM staging.fb_ads_campaign_insights
WHERE date_start >= CURRENT_DATE - 30;

-- Team (–ø—Ä–∏–º–µ—Ä)
SELECT COUNT(DISTINCT request_manager) as team_size
FROM staging.crm_requests;

-- Conversion
SELECT 
    COUNT(CASE WHEN request_status = 'converted' THEN 1 END)::DECIMAL / 
    COUNT(*)::DECIMAL * 100 as conversion_rate
FROM staging.crm_requests
WHERE request_created_at >= CURRENT_DATE - 30;
\`\`\`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: RealTimeMetrics
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
-- Active sessions (last 15 minutes)
SELECT COUNT(DISTINCT session_id) as active_sessions
FROM staging.ga4_events
WHERE event_timestamp >= NOW() - INTERVAL '15 minutes';

-- New leads today
SELECT COUNT(*) as new_leads
FROM staging.crm_requests
WHERE request_created_at >= CURRENT_DATE;

-- Revenue today
SELECT SUM(contract_value) as revenue_today
FROM staging.crm_requests
WHERE request_created_at >= CURRENT_DATE 
  AND request_status = 'converted';
\`\`\`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: ActiveGoals
**–ò—Å—Ç–æ—á–Ω–∏–∫:** ‚ùå –ù–µ—Ç - –Ω—É–∂–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `goals`

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –í–æ—Ä–æ–Ω–∫–∏ `/funnel`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: Funnel Visualization
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
WITH funnel AS (
    SELECT 
        -- Impressions
        SUM(impressions) as impressions,
        -- Clicks
        SUM(clicks) as clicks,
        -- Landing page views (from GA4)
        (SELECT COUNT(*) FROM staging.ga4_events 
         WHERE event_name = 'page_view' 
         AND page_location LIKE '%/courses/%') as landing_views,
        -- Leads
        (SELECT COUNT(*) FROM staging.crm_requests 
         WHERE request_created_at >= :start_date) as leads,
        -- Calls (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ CRM)
        NULL as calls,
        -- Consultations (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ CRM)
        NULL as consultations,
        -- Contracts
        (SELECT COUNT(*) FROM staging.crm_requests 
         WHERE request_status = 'converted' 
         AND request_created_at >= :start_date) as contracts
    FROM staging.fb_ads_creative_insights
    WHERE date_start >= :start_date
)
SELECT * FROM funnel;
\`\`\`

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå –≠—Ç–∞–ø—ã: Phone Calls, Consultations
- ‚ùå –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ç—Ä–∏–±—É—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º
- ‚ùå –í—Ä–µ–º—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ (avg_time_in_stage)
- ‚ùå –ü—Ä–∏—á–∏–Ω—ã –≤—ã—Ö–æ–¥–∞ (top_exit_reasons)

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ö–∞–º–ø–∞–Ω–∏–π `/campaigns`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: CampaignPerformanceTable
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
SELECT 
    c.campaign_id,
    c.campaign_name,
    c.date_start,
    SUM(c.impressions) as impressions,
    SUM(c.clicks) as clicks,
    SUM(c.spend) as spent,
    AVG(c.ctr) as ctr,
    AVG(c.cpc) as cpc,
    SUM(c.actions_offsite_conversion) as conversions,
    -- Revenue - –Ω—É–∂–µ–Ω –¥–∂–æ–π–Ω —Å CRM
    NULL as revenue,
    -- ROAS
    NULL as roas
FROM staging.fb_ads_campaign_insights c
WHERE c.date_start >= :start_date
GROUP BY c.campaign_id, c.campaign_name, c.date_start
ORDER BY spent DESC;
\`\`\`

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå –°–≤—è–∑—å campaign ‚Üí product
- ‚ùå –°–≤—è–∑—å campaign ‚Üí branch
- ‚ùå Revenue –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º
- ‚ùå ROAS –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ö—Ä–µ–∞—Ç–∏–≤–æ–≤ `/creatives`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: Creative Performance Table
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
SELECT 
    c.ad_id as creative_id,
    c.ad_name as name,
    'image' as type, -- ‚ùå –ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å
    'Facebook' as platform,
    c.date_start as date,
    SUM(c.impressions) as impressions,
    SUM(c.clicks) as clicks,
    AVG(c.ctr) as ctr,
    AVG(c.cpc) as cpc,
    AVG(c.cpm) as cpm,
    SUM(c.spend) as spend,
    SUM(c.actions_offsite_conversion_fb_pixel_purchase) as conversions,
    -- Revenue - ‚ùå –Ω—É–∂–µ–Ω –¥–∂–æ–π–Ω
    NULL as revenue,
    -- ROAS
    NULL as roas
FROM staging.fb_ads_creative_insights c
WHERE c.date_start >= :start_date
GROUP BY c.ad_id, c.ad_name, c.date_start
ORDER BY conversions DESC;
\`\`\`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: CreativeBurnoutIndicator
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
WITH creative_performance AS (
    SELECT 
        ad_id,
        ad_name,
        date_start,
        ctr,
        cpc,
        CASE 
            WHEN date_start = MIN(date_start) OVER (PARTITION BY ad_id) 
            THEN ctr 
        END as initial_ctr,
        CASE 
            WHEN date_start = MAX(date_start) OVER (PARTITION BY ad_id) 
            THEN ctr 
        END as current_ctr,
        ROW_NUMBER() OVER (PARTITION BY ad_id ORDER BY date_start) as day_number
    FROM staging.fb_ads_creative_insights
    WHERE date_start >= CURRENT_DATE - 42
)
SELECT 
    ad_id,
    ad_name,
    MAX(initial_ctr) as initial_ctr,
    MAX(current_ctr) as current_ctr,
    MAX(day_number) as days_active,
    -- Burnout score
    CASE 
        WHEN MAX(initial_ctr) > 0 
        THEN (1 - MAX(current_ctr) / MAX(initial_ctr)) * 100
        ELSE 0 
    END as burnout_score
FROM creative_performance
GROUP BY ad_id, ad_name
HAVING MAX(day_number) >= 14;
\`\`\`

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå –¢–∏–ø –∫—Ä–µ–∞—Ç–∏–≤–∞ (video/image/carousel)
- ‚ùå –¢–µ–º–∞ –∫—Ä–µ–∞—Ç–∏–≤–∞
- ‚ùå –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (is_personalized)
- ‚ùå –¢–µ–∫—Å—Ç –∫—Ä–µ–∞—Ç–∏–≤–∞ (title, body)

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¢—Ä–∞—Ñ–∏–∫–∞ `/traffic`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: TrafficChart
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
SELECT 
    DATE(session_start_timestamp) as date,
    COUNT(DISTINCT session_id) as sessions,
    COUNT(DISTINCT user_pseudo_id) as users,
    -- New users - ‚ùå –Ω—É–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    COUNT(DISTINCT CASE WHEN ... THEN user_pseudo_id END) as new_users,
    AVG(CASE 
        WHEN session_engaged_time < 10 THEN 100 
        ELSE 0 
    END) as bounce_rate,
    AVG(session_engaged_time) as avg_duration
FROM staging.ga4_sessions
WHERE session_start_timestamp >= :start_date
GROUP BY DATE(session_start_timestamp)
ORDER BY date;
\`\`\`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: GeoMap
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
SELECT 
    geo_city as city,
    COUNT(DISTINCT session_id) as sessions,
    COUNT(DISTINCT user_pseudo_id) as users,
    -- Engagement rate
    AVG(CASE 
        WHEN session_engaged_time >= 10 THEN 100 
        ELSE 0 
    END) as engagement_rate
FROM staging.ga4_sessions
WHERE session_start_timestamp >= :start_date
  AND geo_city IS NOT NULL
GROUP BY geo_city
ORDER BY sessions DESC
LIMIT 10;
\`\`\`

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå New users (–Ω—É–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ first_visit)
- ‚ùå Conversions –ø–æ —Å–µ—Å—Å–∏—è–º
- ‚ùå Revenue –ø–æ —Å–µ—Å—Å–∏—è–º

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ö–æ–Ω–≤–µ—Ä—Å–∏–π `/conversions`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: Conversion Events Chart
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
SELECT 
    event_name as event,
    COUNT(*) as conversions,
    -- Rate - –Ω—É–∂–µ–Ω —Ä–∞—Å—á–µ—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
    0 as rate,
    -- Revenue - ‚ùå –Ω—É–∂–Ω–∞ —Å–≤—è–∑—å —Å CRM
    0 as revenue
FROM staging.ga4_events
WHERE event_timestamp >= :start_date
  AND event_name IN ('page_view', 'form_submit', 'purchase')
GROUP BY event_name
ORDER BY 
    CASE event_name
        WHEN 'page_view' THEN 1
        WHEN 'form_submit' THEN 2
        WHEN 'purchase' THEN 3
    END;
\`\`\`

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå –ö–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º
- ‚ùå –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (avg_order_value)
- ‚ùå –¶–∏–∫–ª –ø—Ä–æ–¥–∞–∂–∏ (sales_cycle)

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ CRM `/crm`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: Lead Table
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
\`\`\`sql
SELECT 
    r.request_id as id,
    SPLIT_PART(r.request_name, ' ', 1) as first_name,
    r.request_email as email,
    r.request_phone as phone,
    r.request_product as product,
    r.request_branch as branch,
    a.utm_source as source,
    r.request_status as status,
    r.request_created_at as created_at,
    -- ‚ùå –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
    NULL as age,
    NULL as lead_score,
    NULL as temperature,
    NULL as contract_value
FROM staging.crm_requests r
LEFT JOIN staging.crm_requests_attribution a 
    ON r.request_id = a.request_id
WHERE r.request_created_at >= :start_date
ORDER BY r.request_created_at DESC;
\`\`\`

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå Age, gender
- ‚ùå Lead score (0-100)
- ‚ùå Temperature (hot/warm/cold)
- ‚ùå Interactions history
- ‚ùå Last contact date
- ‚ùå Contract value

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ü–ª–∞—Ç—Ñ–æ—Ä–º `/platforms`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: Facebook Performance
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:** ‚úÖ `fb_ads_campaign_insights`, `fb_ads_creative_insights`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: Google Ads Performance
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:** ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ Google Ads

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå Google Ads campaigns
- ‚ùå Google Ads keywords
- ‚ùå Quality Score
- ‚ùå Search impression share

---

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¶–µ–ª–µ–π `/goals`

#### –í—Å–µ —Ç—Ä–∏ —Ç–∞–±–∞ (Burnout, Personalization, Themes)
**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚ùå –¢–∞–±–ª–∏—Ü–∞ `goals`
- ‚ùå –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (is_personalized)
- ‚ùå –¢–µ–º—ã –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (theme)
- ‚ùå –°–≤—è–∑—å –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ —Å –∞—É–¥–∏—Ç–æ—Ä–∏—è–º–∏

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –í–Ω–µ–¥—Ä–µ–Ω–∏—è

### Priority 1: –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –∑–∞–ø—É—Å–∫–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–≤—ã–º)

1. **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å `products` –∏–∑ `crm_requests.request_product`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å `branches` –∏–∑ `crm_requests.request_branch`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å `traffic_sources` –∏–∑ `ga4_sessions.session_source`

2. **–°–≤—è–∑–∏**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å `campaigns` –∏–∑ `fb_ads_campaign_insights`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å `creatives` –∏–∑ `fb_ads_creative_insights`
   - ‚úÖ –°–≤—è–∑–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏/—Ñ–∏–ª–∏–∞–ª–∞–º–∏ —á–µ—Ä–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏–µ

3. **Revenue –¥–ª—è ROAS**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å `contract_value` –≤ `crm_requests`
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å VIEW –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ revenue –ø–æ –∫—Ä–µ–∞—Ç–∏–≤–∞–º
   - ‚úÖ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å ROAS –≤ –≤–∏—Ç—Ä–∏–Ω–∞—Ö

---

### Priority 2: –í–ê–ñ–ù–û –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

4. **CRM Enhancement**
   - ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å `age`, `gender`, `lead_score`, `temperature`
   - ‚ö†Ô∏è –°–æ–∑–¥–∞—Ç—å `lead_interactions`
   - ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å `last_contact_at`

5. **–í–æ—Ä–æ–Ω–∫–∞**
   - ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —ç—Ç–∞–ø—ã (calls, consultations)
   - ‚ö†Ô∏è –°–≤—è–∑–∞—Ç—å GA4 events —Å CRM —á–µ—Ä–µ–∑ attribution
   - ‚ö†Ô∏è –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ —ç—Ç–∞–ø–∞—Ö

6. **–¢–∏–ø—ã –∏ —Ç–µ–º—ã –∫—Ä–µ–∞—Ç–∏–≤–æ–≤**
   - ‚ö†Ô∏è –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å `type` (video/image/carousel)
   - ‚ö†Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `theme`
   - ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å `is_personalized`

---

### Priority 3: –ü–û–õ–ï–ó–ù–û –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

7. **–¶–µ–ª–∏ –∏ KPI**
   - ‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `goals`
   - ‚ûï –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è KPI

8. **Google Ads**
   - ‚ûï –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Google Ads API
   - ‚ûï Keywords data
   - ‚ûï Quality Score

9. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**
   - ‚ûï Hook rate, thumb stops
   - ‚ûï Saves, shares, comments
   - ‚ûï Detailed engagement

---

## –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ë—ã—Å—Ç—Ä–æ–≥–æ –°—Ç–∞—Ä—Ç–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤

\`\`\`sql
-- Products
CREATE TABLE IF NOT EXISTS products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    category VARCHAR(100) DEFAULT 'IT Education',
    price DECIMAL(10, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO products (name, price)
SELECT DISTINCT 
    request_product,
    CASE 
        WHEN request_product ILIKE '%front%' THEN 4800
        WHEN request_product ILIKE '%qa%' OR request_product ILIKE '%—Ç–µ—Å—Ç%' THEN 4200
        WHEN request_product ILIKE '%–¥—ñ—Ç%' OR request_product ILIKE '%kid%' THEN 2800
        WHEN request_product ILIKE '%python%' THEN 4500
        WHEN request_product ILIKE '%–∞–Ω–≥–ª%' OR request_product ILIKE '%english%' THEN 3200
        ELSE 3500
    END
FROM staging.crm_requests
WHERE request_product IS NOT NULL
ON CONFLICT (name) DO NOTHING;

-- Branches
CREATE TABLE IF NOT EXISTS branches (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    city VARCHAR(100),
    region VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO branches (name, city, region)
SELECT DISTINCT 
    request_branch,
    request_city,
    CASE 
        WHEN request_city ILIKE '%–∫–∏—ó–≤%' THEN '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city ILIKE '%—Ö–∞—Ä–∫—ñ–≤%' THEN '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city ILIKE '%–¥–Ω—ñ–ø—Ä%' THEN '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city ILIKE '%–ª—å–≤—ñ–≤%' THEN '–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
        WHEN request_city ILIKE '%–æ–¥–µ—Å%' THEN '–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å'
    END
FROM staging.crm_requests
WHERE request_branch IS NOT NULL
ON CONFLICT (name) DO NOTHING;

-- Traffic Sources
CREATE TABLE IF NOT EXISTS traffic_sources (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    type VARCHAR(50),
    platform VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO traffic_sources (name, type, platform)
SELECT DISTINCT 
    COALESCE(session_source, '(direct)'),
    CASE 
        WHEN session_medium = 'cpc' THEN 'paid'
        WHEN session_medium = 'organic' THEN 'organic'
        WHEN session_medium = '(none)' OR session_medium IS NULL THEN 'direct'
        ELSE 'referral'
    END,
    CASE 
        WHEN session_source ILIKE '%facebook%' OR session_source ILIKE '%fb%' THEN 'Facebook'
        WHEN session_source ILIKE '%google%' THEN 'Google'
        WHEN session_source ILIKE '%instagram%' OR session_source ILIKE '%ig%' THEN 'Instagram'
        WHEN session_source ILIKE '%youtube%' OR session_source ILIKE '%yt%' THEN 'YouTube'
        ELSE NULL
    END
FROM staging.ga4_sessions
WHERE session_source IS NOT NULL
ON CONFLICT (name) DO NOTHING;
\`\`\`

---

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–π –∏ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

\`\`\`sql
-- Campaigns
CREATE TABLE IF NOT EXISTS campaigns (
    id SERIAL PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE,
    name VARCHAR(255) NOT NULL,
    source_id INTEGER REFERENCES traffic_sources(id),
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO campaigns (external_id, name, source_id, status)
SELECT DISTINCT 
    campaign_id,
    campaign_name,
    (SELECT id FROM traffic_sources WHERE name = 'Facebook' LIMIT 1),
    'active'
FROM staging.fb_ads_campaign_insights
WHERE campaign_id IS NOT NULL
ON CONFLICT (external_id) DO NOTHING;

-- Creatives
CREATE TABLE IF NOT EXISTS creatives (
    id SERIAL PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE,
    campaign_id INTEGER REFERENCES campaigns(id),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) DEFAULT 'image',
    platform VARCHAR(50) DEFAULT 'Facebook',
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO creatives (external_id, campaign_id, name, status)
SELECT DISTINCT 
    c.ad_id,
    camp.id,
    c.ad_name,
    'active'
FROM staging.fb_ads_creative_insights c
LEFT JOIN staging.fb_ads_campaign_insights fci 
    ON c.date_start = fci.date_start -- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–≤—è–∑—å
LEFT JOIN campaigns camp 
    ON fci.campaign_id = camp.external_id
WHERE c.ad_id IS NOT NULL
ON CONFLICT (external_id) DO NOTHING;
\`\`\`

---

### 3. VIEW –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ—Ç—Ä–∏–∫–∞–º

\`\`\`sql
-- View: –ö—Ä–µ–∞—Ç–∏–≤—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
CREATE OR REPLACE VIEW v_creative_metrics AS
SELECT 
    cr.id as creative_id,
    cr.name as creative_name,
    cr.type,
    cr.platform,
    c.date_start as date,
    c.impressions,
    c.clicks,
    c.reach,
    c.frequency,
    c.ctr,
    c.cpc,
    c.cpm,
    c.spend,
    COALESCE(c.actions_offsite_conversion_fb_pixel_purchase, 0) as conversions,
    COALESCE(c.actions_offsite_conversion_fb_pixel_lead, 0) as leads,
    -- Revenue (–¥–∂–æ–π–Ω —Å CRM —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ü–∏—é)
    COALESCE(rev.revenue, 0) as revenue,
    -- ROAS
    CASE 
        WHEN c.spend > 0 THEN COALESCE(rev.revenue, 0) / c.spend
        ELSE 0 
    END as roas,
    -- Days active
    CURRENT_DATE - MIN(c.date_start) OVER (PARTITION BY cr.id) as days_active
FROM creatives cr
JOIN staging.fb_ads_creative_insights c ON cr.external_id = c.ad_id
LEFT JOIN (
    SELECT 
        a.creative_id,
        DATE(r.request_created_at) as date,
        SUM(CASE 
            WHEN r.request_status = 'converted' THEN p.price
            ELSE 0 
        END) as revenue
    FROM staging.crm_requests_attribution a
    JOIN staging.crm_requests r ON a.request_id = r.request_id
    JOIN products p ON r.request_product = p.name
    GROUP BY a.creative_id, DATE(r.request_created_at)
) rev ON cr.external_id = rev.creative_id AND c.date_start = rev.date;

-- View: –õ–∏–¥—ã —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
CREATE OR REPLACE VIEW v_leads_full AS
SELECT 
    r.request_id as id,
    SPLIT_PART(r.request_name, ' ', 1) as first_name,
    SUBSTRING(r.request_name FROM POSITION(' ' IN r.request_name) + 1) as last_name,
    r.request_email as email,
    r.request_phone as phone,
    r.request_city as city,
    p.id as product_id,
    p.name as product,
    b.id as branch_id,
    b.name as branch,
    ts.id as source_id,
    ts.name as source,
    a.utm_campaign,
    a.utm_content,
    r.request_status as status,
    r.request_created_at as created_at,
    p.price as contract_value
FROM staging.crm_requests r
LEFT JOIN staging.crm_requests_attribution a ON r.request_id = a.request_id
LEFT JOIN products p ON r.request_product = p.name
LEFT JOIN branches b ON r.request_branch = b.name
LEFT JOIN traffic_sources ts ON a.utm_source = ts.name;
\`\`\`

---

## –ò—Ç–æ–≥–æ–≤—ã–π –ß–µ–∫–ª–∏—Å—Ç

### ‚úÖ –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
- FB Ads campaigns data
- FB Ads creatives data
- GA4 sessions data
- GA4 events data
- CRM requests (leads)
- CRM attribution (UTM)

### ‚ùå –ß—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
1. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (products, branches, traffic_sources)
2. –¢–∞–±–ª–∏—Ü—ã —Å–≤—è–∑–µ–π (campaigns, creatives)
3. Revenue –¥–∞–Ω–Ω—ã–µ –¥–ª—è ROAS
4. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ ID –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π

### ‚ö†Ô∏è –ß—Ç–æ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
1. Lead scoring & temperature
2. Lead interactions
3. –¢–∏–ø—ã –∏ —Ç–µ–º—ã –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
4. –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —ç—Ç–∞–ø—ã –≤–æ—Ä–æ–Ω–∫–∏

### ‚ûï –ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ:
1. Google Ads integration
2. –¢–∞–±–ª–∏—Ü–∞ goals
3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ engagement –º–µ—Ç—Ä–∏–∫–∏
4. A/B —Ç–µ—Å—Ç—ã –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

–≠—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! üéØ
