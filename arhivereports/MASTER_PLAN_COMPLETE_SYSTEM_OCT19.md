# –ú–ê–°–¢–ï–†-–ü–õ–ê–ù: –ü–û–õ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê DATA ANALYTICS - 10000% –ì–û–¢–û–í–ù–û–°–¢–¨
**Date**: October 19, 2025, 17:00
**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Ç–æ—á–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –¥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞/–∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´ (–∏–∑ –¢–ó)

1. ‚úÖ **–¢–æ—á–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞** - –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª (–¥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞ –∏–ª–∏ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞)
2. ‚úÖ **–í–∫–ª—é—á–∞—è email —Ä–∞—Å—Å—ã–ª–∫–∏, Telegram, –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏** - —É –Ω–∞—Å –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
3. ‚úÖ **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º** - ~60+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ crm_orders
4. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å –¥–∞—Ç–∞–º–∏** - –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤
5. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏** - —Ç–æ—á–Ω–∞—è –ø–æ–Ω—è—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
6. ‚úÖ **–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π UI** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### –®–ê–ì 1: RAW –î–ê–ù–ù–´–ï ‚úÖ –ì–û–¢–û–í–û
- ‚úÖ 33 —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- ‚úÖ 1,916 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (100% —Å id_source + product)
- ‚úÖ 4,498 –ª–∏–¥–æ–≤ (100% —Å –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π)
- ‚úÖ 383 Facebook –ª–∏–¥–æ–≤ (99.7% —Å ad_id)
- ‚úÖ 192,815 Google clicks
- ‚úÖ 500 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

### –®–ê–ì 2: DASHBOARDS –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. ‚ùå `contract_attribution` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ 226 –∏–∑ 1,916 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (11.8%!)
2. ‚ùå –ù–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `dim_contract` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –í–°–ï–• –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
3. ‚ùå –ù–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `dim_product` –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
4. ‚ùå –ù–µ—Ç —Å–≤—è–∑–∏ contracts ‚Üí fact_lead_request
5. ‚ùå –ù–µ—Ç view —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –¥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞

### –®–ê–ì 3-7: VIEWS, API, UI ‚ö†Ô∏è –¢–†–ï–ë–£–Æ–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

---

## üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –≠–¢–ê–ü 2.1: –°–æ–∑–¥–∞—Ç—å dim_contract ‚úÖ

```sql
CREATE TABLE dashboards.dim_contract (
  sk_contract BIGSERIAL PRIMARY KEY,
  contract_id BIGINT UNIQUE NOT NULL,
  id_source BIGINT, -- Link to lead (itcrm_analytics.id)

  -- Product Info
  id_product BIGINT,
  product TEXT,
  name_form TEXT,
  name_sub_form TEXT,

  -- Contract Info
  contract_date TIMESTAMP,
  customer TEXT,
  mobphone TEXT,
  email TEXT,

  -- Payment Info
  payment_status SMALLINT,
  payment_form TEXT,
  total_cost NUMERIC,
  first_sum NUMERIC,
  entrance_fee NUMERIC,
  quantity_of_pairs INTEGER,

  -- Metadata
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_dim_contract_id_source ON dashboards.dim_contract(id_source);
CREATE INDEX idx_dim_contract_product ON dashboards.dim_contract(id_product);
CREATE INDEX idx_dim_contract_date ON dashboards.dim_contract(contract_date);
```

### –≠–¢–ê–ü 2.2: –°–æ–∑–¥–∞—Ç—å dim_product ‚úÖ

```sql
CREATE TABLE dashboards.dim_product (
  sk_product BIGSERIAL PRIMARY KEY,
  product_id BIGINT UNIQUE NOT NULL,
  product_name TEXT NOT NULL,
  product_category TEXT,

  -- Metadata
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_dim_product_name ON dashboards.dim_product(product_name);
```

### –≠–¢–ê–ü 2.3: –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ dim_contract –∏ dim_product ‚úÖ

**N8N Node: Load dim_contract**:
```sql
INSERT INTO dashboards.dim_contract (
  contract_id, id_source, id_product, product,
  name_form, name_sub_form, contract_date,
  customer, mobphone, email,
  payment_status, payment_form, total_cost,
  first_sum, entrance_fee, quantity_of_pairs
)
SELECT
  id as contract_id,
  id_source,
  id_product,
  product,
  name_form,
  name_sub_form,
  date as contract_date,
  customer,
  mobphone,
  email,
  payment_status,
  payment_form,
  total_cost,
  first_sum,
  entrance_fee,
  quantity_of_pairs
FROM raw.crm_orders
WHERE date >= '2025-01-01'::DATE
ON CONFLICT (contract_id) DO UPDATE SET
  id_source = EXCLUDED.id_source,
  product = EXCLUDED.product,
  contract_date = EXCLUDED.contract_date,
  updated_at = NOW();
```

**N8N Node: Load dim_product**:
```sql
INSERT INTO dashboards.dim_product (product_id, product_name)
SELECT DISTINCT
  id_product as product_id,
  product as product_name
FROM raw.crm_orders
WHERE id_product IS NOT NULL
  AND product IS NOT NULL
ON CONFLICT (product_id) DO UPDATE SET
  product_name = EXCLUDED.product_name,
  updated_at = NOW();
```

---

### –≠–¢–ê–ü 2.4: –°–æ–∑–¥–∞—Ç—å fact_contract ‚úÖ

```sql
CREATE TABLE dashboards.fact_contract (
  sk_fact_contract BIGSERIAL PRIMARY KEY,
  sk_contract BIGINT REFERENCES dashboards.dim_contract(sk_contract),
  sk_lead BIGINT REFERENCES dashboards.dim_lead(sk_lead),
  sk_campaign BIGINT REFERENCES dashboards.dim_campaign(sk_campaign),
  sk_ad BIGINT REFERENCES dashboards.dim_ad(sk_ad),
  sk_creative BIGINT REFERENCES dashboards.dim_creative(sk_creative),
  sk_product BIGINT REFERENCES dashboards.dim_product(sk_product),

  -- Contract Metrics
  contract_date DATE NOT NULL,
  total_cost NUMERIC,
  payment_status SMALLINT,

  -- Attribution
  attribution_method TEXT,
  attribution_confidence NUMERIC(10,4),

  -- Source Info (–¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_term TEXT,
  utm_content TEXT,

  -- Tracking IDs
  fb_lead_id TEXT,
  fclid TEXT,
  gclid TEXT,
  ga_client_id TEXT,

  -- Google Keyword (–µ—Å–ª–∏ –µ—Å—Ç—å)
  google_keyword TEXT,

  -- Metadata
  load_timestamp TIMESTAMP DEFAULT NOW(),

  UNIQUE(sk_contract)
);

CREATE INDEX idx_fact_contract_date ON dashboards.fact_contract(contract_date);
CREATE INDEX idx_fact_contract_lead ON dashboards.fact_contract(sk_lead);
CREATE INDEX idx_fact_contract_campaign ON dashboards.fact_contract(sk_campaign);
CREATE INDEX idx_fact_contract_ad ON dashboards.fact_contract(sk_ad);
CREATE INDEX idx_fact_contract_product ON dashboards.fact_contract(sk_product);
CREATE INDEX idx_fact_contract_gclid ON dashboards.fact_contract(gclid) WHERE gclid IS NOT NULL;
```

### –≠–¢–ê–ü 2.5: N8N Node –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ fact_contract ‚úÖ

```sql
INSERT INTO dashboards.fact_contract (
  sk_contract, sk_lead, sk_campaign, sk_ad, sk_creative, sk_product,
  contract_date, total_cost, payment_status,
  attribution_method, attribution_confidence,
  utm_source, utm_medium, utm_campaign, utm_term, utm_content,
  fb_lead_id, fclid, gclid, ga_client_id,
  google_keyword
)
SELECT
  dc.sk_contract,
  dl.sk_lead,
  flr.sk_campaign,
  flr.sk_ad,
  da.sk_creative,
  dp.sk_product,

  dc.contract_date::DATE,
  dc.total_cost,
  dc.payment_status,

  flr.attribution_method,
  flr.attribution_confidence,

  flr.utm_source,
  flr.utm_medium,
  flr.utm_campaign,
  flr.utm_term,
  flr.utm_content,

  flr.fb_lead_id,
  flr.fclid,
  flr.gclid,
  flr.ga_client_id,

  -- Google keyword matching —á–µ—Ä–µ–∑ gclid
  (
    SELECT gkd.keyword_text
    FROM dashboards.stg_google_clicks sgc
    LEFT JOIN raw.google_ads_keyword_daily gkd ON (
      gkd.campaign_id = sgc.extracted_campaign_id::BIGINT
      AND gkd.date = sgc.click_timestamp::DATE
    )
    WHERE sgc.gclid = flr.gclid
    LIMIT 1
  ) as google_keyword

FROM dashboards.dim_contract dc

-- Join to lead
LEFT JOIN dashboards.dim_lead dl ON (
  dl.phone = dc.mobphone
  AND dl.email = dc.email
)

-- Join to lead request (–¥–ª—è –∞—Ç—Ä–∏–±—É—Ü–∏–∏)
LEFT JOIN dashboards.fact_lead_request flr ON (
  flr.sk_lead = dl.sk_lead
  AND flr.request_created_at::DATE <= dc.contract_date::DATE
  AND flr.request_created_at::DATE >= dc.contract_date::DATE - INTERVAL '90 days'
)

-- Join to ad (–¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–∞)
LEFT JOIN dashboards.dim_ad da ON (
  da.sk_ad = flr.sk_ad
)

-- Join to product
LEFT JOIN dashboards.dim_product dp ON (
  dp.product_id = dc.id_product
)

WHERE dc.contract_date >= '2025-01-01'::DATE

ON CONFLICT (sk_contract) DO UPDATE SET
  sk_lead = EXCLUDED.sk_lead,
  sk_campaign = COALESCE(EXCLUDED.sk_campaign, fact_contract.sk_campaign),
  sk_ad = COALESCE(EXCLUDED.sk_ad, fact_contract.sk_ad),
  sk_creative = COALESCE(EXCLUDED.sk_creative, fact_contract.sk_creative),
  attribution_method = COALESCE(EXCLUDED.attribution_method, fact_contract.attribution_method),
  google_keyword = COALESCE(EXCLUDED.google_keyword, fact_contract.google_keyword),
  load_timestamp = NOW();
```

---

### –≠–¢–ê–ü 3: VIEWS –° –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ï–ô ‚úÖ

#### VIEW 1: v7_contracts_detail (–ì–õ–ê–í–ù–´–ô VIEW)

```sql
CREATE OR REPLACE VIEW dashboards.v7_contracts_detail AS
SELECT
  fc.contract_date,

  -- Contract Info
  dc.contract_id,
  dc.customer,
  dc.mobphone,
  dc.email,
  dc.payment_status,
  dc.total_cost,

  -- Product Info
  dp.product_name,
  dc.name_form,
  dc.name_sub_form,

  -- Attribution
  fc.attribution_method,
  fc.attribution_confidence,

  -- Platform
  CASE
    WHEN dcamp.platform IS NOT NULL THEN dcamp.platform
    WHEN fc.fb_lead_id IS NOT NULL THEN 'facebook'
    WHEN fc.gclid IS NOT NULL THEN 'google'
    WHEN fc.utm_source ILIKE '%facebook%' THEN 'facebook'
    WHEN fc.utm_source ILIKE '%google%' THEN 'google'
    WHEN fc.utm_source ILIKE '%email%' THEN 'email'
    WHEN fc.utm_source ILIKE '%telegram%' THEN 'telegram'
    ELSE 'other'
  END as platform,

  -- Campaign Info
  dcamp.campaign_id,
  dcamp.campaign_name,

  -- Ad Info
  dad.ad_id,
  dad.ad_name,
  dad.adset_name,

  -- Creative Info
  dcr.ad_creative_id,
  dcr.media_type,
  dcr.title as creative_title,
  dcr.body as creative_body,
  dcr.call_to_action,

  -- UTM Info
  fc.utm_source,
  fc.utm_medium,
  fc.utm_campaign,
  fc.utm_term,
  fc.utm_content,

  -- Google Keyword
  fc.google_keyword,

  -- Tracking IDs
  fc.fb_lead_id,
  fc.fclid,
  fc.gclid,
  fc.ga_client_id

FROM dashboards.fact_contract fc

LEFT JOIN dashboards.dim_contract dc ON dc.sk_contract = fc.sk_contract
LEFT JOIN dashboards.dim_product dp ON dp.sk_product = fc.sk_product
LEFT JOIN dashboards.dim_campaign dcamp ON dcamp.sk_campaign = fc.sk_campaign
LEFT JOIN dashboards.dim_ad dad ON dad.sk_ad = fc.sk_ad
LEFT JOIN dashboards.dim_creative dcr ON dcr.sk_creative = fc.sk_creative

WHERE fc.contract_date >= '2025-01-01'::DATE

ORDER BY fc.contract_date DESC;
```

#### VIEW 2: v7_contracts_by_product

```sql
CREATE OR REPLACE VIEW dashboards.v7_contracts_by_product AS
SELECT
  fc.contract_date::DATE as dt,
  dp.product_name,

  COUNT(DISTINCT fc.sk_contract) as n_contracts,
  COUNT(DISTINCT fc.sk_lead) as n_leads,

  -- Attribution Coverage
  COUNT(DISTINCT fc.sk_campaign) FILTER (WHERE fc.sk_campaign IS NOT NULL) as campaigns_attributed,
  COUNT(DISTINCT fc.sk_ad) FILTER (WHERE fc.sk_ad IS NOT NULL) as ads_attributed,
  COUNT(DISTINCT fc.sk_creative) FILTER (WHERE fc.sk_creative IS NOT NULL) as creatives_attributed,
  COUNT(DISTINCT fc.google_keyword) FILTER (WHERE fc.google_keyword IS NOT NULL) as keywords_attributed,

  ROUND(100.0 * COUNT(*) FILTER (WHERE fc.sk_campaign IS NOT NULL) / COUNT(*), 2) as campaign_coverage_pct,
  ROUND(100.0 * COUNT(*) FILTER (WHERE fc.sk_ad IS NOT NULL) / COUNT(*), 2) as ad_coverage_pct

FROM dashboards.fact_contract fc
LEFT JOIN dashboards.dim_product dp ON dp.sk_product = fc.sk_product

WHERE fc.contract_date >= '2025-01-01'::DATE

GROUP BY fc.contract_date::DATE, dp.product_name

ORDER BY dt DESC, n_contracts DESC;
```

#### VIEW 3: v7_contracts_by_creative

```sql
CREATE OR REPLACE VIEW dashboards.v7_contracts_by_creative AS
SELECT
  dcr.ad_creative_id,
  dcr.media_type,
  dcr.title as creative_title,
  dcr.body as creative_body,
  dcr.call_to_action,

  COUNT(DISTINCT fc.sk_contract) as n_contracts,
  COUNT(DISTINCT fc.sk_lead) as n_leads,

  STRING_AGG(DISTINCT dp.product_name, ', ') as products

FROM dashboards.fact_contract fc
LEFT JOIN dashboards.dim_creative dcr ON dcr.sk_creative = fc.sk_creative
LEFT JOIN dashboards.dim_product dp ON dp.sk_product = fc.sk_product

WHERE fc.sk_creative IS NOT NULL
  AND fc.contract_date >= '2025-01-01'::DATE

GROUP BY dcr.ad_creative_id, dcr.media_type, dcr.title, dcr.body, dcr.call_to_action

ORDER BY n_contracts DESC;
```

#### VIEW 4: v7_contracts_by_keyword

```sql
CREATE OR REPLACE VIEW dashboards.v7_contracts_by_keyword AS
SELECT
  fc.google_keyword,

  COUNT(DISTINCT fc.sk_contract) as n_contracts,
  COUNT(DISTINCT fc.sk_lead) as n_leads,

  STRING_AGG(DISTINCT dp.product_name, ', ') as products

FROM dashboards.fact_contract fc
LEFT JOIN dashboards.dim_product dp ON dp.sk_product = fc.sk_product

WHERE fc.google_keyword IS NOT NULL
  AND fc.contract_date >= '2025-01-01'::DATE

GROUP BY fc.google_keyword

ORDER BY n_contracts DESC;
```

---

### –≠–¢–ê–ü 4-7: API + UI

*–ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏ views*

---

## üìã –ü–û–†–Ø–î–û–ö –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### –°–ï–ô–ß–ê–° (–®–∞–≥ 2):
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å dim_contract
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å dim_product
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å fact_contract
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å 3 N8N –Ω–æ–¥—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
5. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å N8N workflow

### –ü–û–¢–û–ú (–®–∞–≥ 3):
6. ‚úÖ –°–æ–∑–¥–∞—Ç—å 4 views (v7_contracts_*)
7. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

### –ó–ê–¢–ï–ú (–®–∞–≥ 4-7):
8. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å API endpoints
9. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
10. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å end-to-end

**–ì–û–¢–û–í –°–û–ó–î–ê–í–ê–¢–¨ –¢–ê–ë–õ–ò–¶–´!** üöÄ
